{% extends 'core/base.html' %}
{% load static %}

{% block extra_head %}
<script src="{% static 'js/dashboard.js' %}"></script>
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/radar.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<style>
#chartdiv {
  width: 100%;
  height: 500px;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h2>Dashboard</h2>
        <form method="get" class="campaign-selector">
            <div class="form-group">
                <label for="campaign">Seleccionar Campaña:</label>
                <div class="select-wrapper">
                    <select name="campaign" id="campaign" class="custom-select" onchange="this.form.submit()">
                        <option value="">-- Seleccione una campaña --</option>
                        {% for campaign in campaigns %}
                            <option value="{{ campaign.id }}" {% if selected_campaign.id == campaign.id %}selected{% endif %}>
                                {{ campaign.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <span class="select-arrow"></span>
                </div>
            </div>
        </form>
    </div>

    {% if selected_campaign %}
        <h3>Resultados de la campaña: {{ selected_campaign.name }}</h3>
        <div class="export-buttons">
            <a href="{% url 'export_campaign_results' selected_campaign.id 'excel' %}" class="btn btn-success">Exportar a Excel</a>
        </div>
        
        <!-- Añade este div para el gráfico -->
        <div id="chartdiv" style="width: 100%; height: 300px;"></div>

        <div class="table-responsive">
            <table id="resultsTable" class="table table-striped table-hover table-bordered mt-4">
                <thead class="table-dark">
                    <tr>
                        <th>Email</th>
                        <th>Enviado</th>
                        <th>Abierto</th>
                        <th>Interacción</th>
                        <th>Detalles</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in results %}
                        <tr>
                            <td>{{ result.target.email }}</td>
                            <td data-filter="sent">
                                {% if result.email_sent %}
                                    <i class="material-icons status-icon sent">check_circle</i>
                                {% else %}
                                    <i class="material-icons status-icon not-sent">cancel</i>
                                {% endif %}
                            </td>
                            <td data-filter="opened">
                                {% if result.email_opened %}
                                    <i class="material-icons status-icon opened">visibility</i>
                                {% else %}
                                    <i class="material-icons status-icon not-opened">visibility_off</i>
                                {% endif %}
                            </td>
                            <td data-filter="interacted">
                                {% if result.landing_page_opened %}
                                    <i class="material-icons status-icon interacted">touch_app</i>
                                {% else %}
                                    <i class="material-icons status-icon not-interacted">do_not_touch</i>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="toggleDetails({{ result.id }})">Ver detalles</button>
                            </td>
                        </tr>
                        <tr id="details-{{ result.id }}" style="display: none;">
                            <td colspan="5">
                                <div class="target-details">
                                    <h4>Detalles del Formulario</h4>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <span class="detail-label">IP:</span>
                                            <span class="detail-value">{{ result.ip_address|default:"No disponible" }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">User Agent:</span>
                                            <span class="detail-value">{{ result.user_agent|default:"No disponible" }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Fecha de envío:</span>
                                            <span class="detail-value">{{ result.sent_timestamp|default:"No disponible" }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Fecha de apertura:</span>
                                            <span class="detail-value">{{ result.opened_timestamp|default:"No disponible" }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Fecha de apertura de landing page:</span>
                                            <span class="detail-value">{{ result.landing_page_opened_timestamp|default:"No disponible" }}</span>
                                        </div>
                                    </div>
                                    <h5>Datos Enviados:</h5>
                                    <ul class="submitted-data">
                                        {% if result.post_data %}
                                            {% for key, value in result.post_data.items %}
                                                <li><strong>{{ key }}:</strong> {{ value }}</li>
                                            {% endfor %}
                                        {% else %}
                                            <li>No hay datos enviados.</li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">No hay resultados para esta campaña.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        
    {% else %}
        <p>Seleccione una campaña para ver sus resultados.</p>
    {% endif %}

    <script>
        console.log("Datos del gráfico (raw):", {{ chart_data|safe }});
        
        am5.ready(function() {
            var root = am5.Root.new("chartdiv");
            root.setThemes([am5themes_Animated.new(root)]);

            var chart = root.container.children.push(
                am5radar.RadarChart.new(root, {
                    panX: false,
                    panY: false,
                    wheelX: "panX",
                    wheelY: "zoomX",
                    innerRadius: am5.percent(20),
                    startAngle: -90,
                    endAngle: 180
                })
            );

            var data = {{ chart_data|safe }};
            console.log("Datos del gráfico (parsed):", data);

            // Obtener los colores del CSS
            var colors = [
                getComputedStyle(document.documentElement).getPropertyValue('--md-sys-color-primary'),
                getComputedStyle(document.documentElement).getPropertyValue('--md-sys-color-secondary'),
                getComputedStyle(document.documentElement).getPropertyValue('--md-sys-color-tertiary'),
                getComputedStyle(document.documentElement).getPropertyValue('--md-sys-color-error')
            ];

            // Asignar colores a los datos
            data.forEach((item, index) => {
                item.columnSettings = {
                    fill: am5.color(colors[index % colors.length])
                };
            });

            var cursor = chart.set("cursor", am5radar.RadarCursor.new(root, {
                behavior: "zoomX"
            }));

            cursor.lineY.set("visible", false);

            var xRenderer = am5radar.AxisRendererCircular.new(root, {});
            xRenderer.labels.template.setAll({
                radius: 10
            });

            xRenderer.grid.template.setAll({
                forceHidden: true
            });

            var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root, {
                renderer: xRenderer,
                min: 0,
                max: 100,
                strictMinMax: true,
                numberFormat: "#'%'"
            }));

            var yRenderer = am5radar.AxisRendererRadial.new(root, {
                minGridDistance: 20
            });

            yRenderer.labels.template.setAll({
                centerX: am5.p100,
                fontWeight: "500",
                fontSize: 18,
                templateField: "columnSettings"
            });

            yRenderer.grid.template.setAll({
                forceHidden: true
            });

            var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root, {
                categoryField: "label",
                renderer: yRenderer
            }));

            yAxis.data.setAll(data);

            var series1 = chart.series.push(am5radar.RadarColumnSeries.new(root, {
                xAxis: xAxis,
                yAxis: yAxis,
                clustered: false,
                valueXField: "full",
                categoryYField: "label",
                fill: root.interfaceColors.get("alternativeBackground")
            }));

            series1.columns.template.setAll({
                width: am5.p100,
                fillOpacity: 0.08,
                strokeOpacity: 0,
                cornerRadius: 20
            });

            series1.data.setAll(data);

            var series2 = chart.series.push(am5radar.RadarColumnSeries.new(root, {
                xAxis: xAxis,
                yAxis: yAxis,
                clustered: false,
                valueXField: "y",
                categoryYField: "label"
            }));

            series2.columns.template.setAll({
                width: am5.p100,
                strokeOpacity: 0,
                tooltipText: "{label}: {valueX}%",
                cornerRadius: 20,
                templateField: "columnSettings"
            });

            series2.data.setAll(data);

            series1.appear(1000);
            series2.appear(1000);
            chart.appear(1000, 100);
        });
    </script>
{% endblock %}







