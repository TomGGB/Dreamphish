{% extends 'core/base.html' %}
{% load static %}

{% block content %}
    <h2><span class="material-icons">email</span> Perfiles SMTP</h2>
    <a href="{% url 'add_smtp' %}" class="btn btn-primary">
        <span class="material-icons">add</span> Añadir Perfil SMTP
    </a>
    <table class="table">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Host</th>
                <th>Usuario</th>
                <th>Puerto</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for smtp in smtps %}
                <tr>
                    <td>{{ smtp.name }}</td>
                    <td>{{ smtp.host }}</td>
                    <td>{{ smtp.username }}</td>
                    <td>{{ smtp.port }}</td>
                    <td>
                        <a href="{% url 'edit_smtp' smtp.id %}" class="btn btn-warning">Editar</a>
                        <button class="btn btn-info modal-trigger" data-modal-target="testSMTPModal{{ smtp.id }}">Probar</button>
                        <form method="post" action="{% url 'delete_smtp' smtp.id %}" class="inline-form">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger" onclick="return confirm('¿Estás seguro de que quieres eliminar este perfil SMTP?')">Eliminar</button>
                        </form>
                    </td>
                </tr>
                <!-- Modal para la prueba de SMTP -->
                <div class="modal hidden" id="testSMTPModal{{ smtp.id }}">
                    <div class="modal-content">
                        <h3>Probar SMTP</h3>
                        <button class="close-modal">&times;</button>
                        <form method="post" action="{% url 'test_smtp' smtp.id %}">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="testEmail{{ smtp.id }}">Correo de prueba:</label>
                                <input type="email" id="testEmail{{ smtp.id }}" name="test_email" required>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary close-modal">Cerrar</button>
                                <button type="submit" class="btn btn-primary">Enviar correo de prueba</button>
                            </div>
                        </form>
                    </div>
                </div>
            {% empty %}
                <tr>
                    <td colspan="5">No hay perfiles SMTP registrados.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modals = document.querySelectorAll('.modal');
        const modalTriggers = document.querySelectorAll('.modal-trigger');
        const closeButtons = document.querySelectorAll('.close-modal');

        modalTriggers.forEach(trigger => {
            trigger.addEventListener('click', () => {
                const modalId = trigger.getAttribute('data-modal-target');
                const modal = document.getElementById(modalId);
                openModal(modal);
            });
        });

        closeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const modal = button.closest('.modal');
                closeModal(modal);
            });
        });

        modals.forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal);
                }
            });
        });

        function openModal(modal) {
            if (modal == null) return;
            modal.classList.remove('hidden');
        }

        function closeModal(modal) {
            if (modal == null) return;
            modal.classList.add('hidden');
        }
    });
    </script>
{% endblock %}